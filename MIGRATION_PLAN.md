# Monorepo Migration Plan

## Current Status

✅ **Completed:**
- Root monorepo structure created at `/Users/pato/bermuda-rocket-tracker-monorepo/`
- Turborepo configuration set up (`turbo.json`)
- Root `package.json` with workspace configuration
- `packages/shared` directory created with proper structure

⏳ **In Progress:**
- Setting up packages/shared package.json

❌ **Not Started:**
- Moving existing code into monorepo
- Creating platform abstraction layer
- Setting up build pipeline

---

## Directory Structure (Target)

```
/Users/pato/bermuda-rocket-tracker-monorepo/
├── package.json                    # ✅ Root workspace config
├── turbo.json                      # ✅ Turbo configuration
├── .gitignore
├── README.md
├── packages/
│   ├── shared/                     # ⏳ Shared business logic
│   │   ├── package.json           # ✅ Created
│   │   ├── tsconfig.json          # ❌ Need to create
│   │   ├── src/
│   │   │   ├── index.ts           # ❌ Need to create (exports)
│   │   │   ├── services/          # ❌ Copy from web app
│   │   │   ├── utils/             # ❌ Copy from web app
│   │   │   ├── types/             # ❌ Copy from web app
│   │   │   └── adapters/          # ❌ Create new (storage, notifications)
│   │   └── dist/                  # (generated by build)
│   ├── web/                        # ❌ Move existing web app here
│   │   ├── package.json
│   │   ├── src/
│   │   └── public/
│   └── mobile/                     # ❌ Move existing mobile app here
│       ├── package.json
│       ├── app.json
│       └── src/
└── node_modules/                   # (generated)
```

---

## Step-by-Step Migration Guide

### Phase 1: Complete Shared Package Setup (30 mins)

#### 1.1 Create TypeScript Config
```bash
cd /Users/pato/bermuda-rocket-tracker-monorepo/packages/shared
```

Create `tsconfig.json`:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020"],
    "moduleResolution": "bundler",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.spec.ts", "**/*.test.ts"]
}
```

#### 1.2 Copy Services from Web App
```bash
# Copy services (browser-independent ones first)
cp -r /Users/pato/bermuda-rocket-tracker/src/services/*.ts \
     /Users/pato/bermuda-rocket-tracker-monorepo/packages/shared/src/services/

# Copy utils
cp -r /Users/pato/bermuda-rocket-tracker/src/utils \
     /Users/pato/bermuda-rocket-tracker-monorepo/packages/shared/src/

# Copy types
cp /Users/pato/bermuda-rocket-tracker/src/types.ts \
   /Users/pato/bermuda-rocket-tracker-monorepo/packages/shared/src/types/index.ts
```

#### 1.3 Create Main Export File
Create `src/index.ts`:
```typescript
// Export all services
export * from './services/visibilityService';
export * from './services/trajectoryService';
export * from './services/bermudaTimeService';
// ... export all services

// Export all utils
export * from './utils/coordinateUtils';
export * from './utils/timeUtils';
// ... export all utils

// Export types
export * from './types';
```

#### 1.4 Install Dependencies & Build
```bash
cd /Users/pato/bermuda-rocket-tracker-monorepo/packages/shared
npm install
npm run build
```

---

### Phase 2: Move Web App (1 hour)

#### 2.1 Move Existing Web App
```bash
# Move the entire web app
mv /Users/pato/bermuda-rocket-tracker \
   /Users/pato/bermuda-rocket-tracker-monorepo/packages/web
```

#### 2.2 Update Web App package.json
Edit `packages/web/package.json`:
```json
{
  "name": "@bermuda/web",
  "dependencies": {
    "@bermuda/shared": "workspace:*",
    // ... keep existing dependencies
  }
}
```

#### 2.3 Update Web App Imports
Replace local imports with workspace imports:
```typescript
// Before:
import { calculateVisibility } from '../services/visibilityService';
import { Launch } from '../types';

// After:
import { calculateVisibility, Launch } from '@bermuda/shared';
```

Use find/replace in VS Code:
- Find: `from '../services/`
- Replace: `from '@bermuda/shared/services/`

- Find: `from '../utils/`
- Replace: `from '@bermuda/shared/utils/`

- Find: `from '../types'`
- Replace: `from '@bermuda/shared/types'`

#### 2.4 Remove Duplicate Code from Web
```bash
cd /Users/pato/bermuda-rocket-tracker-monorepo/packages/web
rm -rf src/services  # Now using @bermuda/shared
rm -rf src/utils     # Now using @bermuda/shared
rm src/types.ts      # Now using @bermuda/shared
```

---

### Phase 3: Move Mobile App (1 hour)

#### 3.1 Move Existing Mobile App
```bash
mv /Users/pato/bermuda-rocket-tracker-mobile \
   /Users/pato/bermuda-rocket-tracker-monorepo/packages/mobile
```

#### 3.2 Update Mobile package.json
Edit `packages/mobile/package.json`:
```json
{
  "name": "@bermuda/mobile",
  "dependencies": {
    "@bermuda/shared": "workspace:*",
    // ... keep Expo dependencies
  }
}
```

#### 3.3 Remove Duplicate Copied Code
```bash
cd /Users/pato/bermuda-rocket-tracker-monorepo/packages/mobile
rm -rf src/shared  # Delete the literal copies
```

#### 3.4 Update Mobile Imports
Same as web app - replace local imports with `@bermuda/shared`

---

### Phase 4: Install & Test (30 mins)

#### 4.1 Install All Dependencies
```bash
cd /Users/pato/bermuda-rocket-tracker-monorepo
npm install
```

This will:
- Install root dependencies
- Install dependencies for all packages
- Link workspace packages together

#### 4.2 Build Everything
```bash
npm run build
```

#### 4.3 Test Web App
```bash
cd packages/web
npm start
```

Should work identically to before!

#### 4.4 Test Mobile App
```bash
cd packages/mobile
npx expo start
```

---

### Phase 5: Create Platform Adapters (2-3 hours)

Now that monorepo is set up, create abstraction layer for browser vs mobile.

#### 5.1 Create Storage Adapter Interface
`packages/shared/src/adapters/storage.ts`:
```typescript
export interface IStorageAdapter {
  getItem(key: string): Promise<string | null>;
  setItem(key: string, value: string): Promise<void>;
  removeItem(key: string): Promise<void>;
  clear(): Promise<void>;
}

// Platform implementations injected at runtime
let storageAdapter: IStorageAdapter | null = null;

export function setStorageAdapter(adapter: IStorageAdapter) {
  storageAdapter = adapter;
}

export function getStorageAdapter(): IStorageAdapter {
  if (!storageAdapter) {
    throw new Error('Storage adapter not initialized');
  }
  return storageAdapter;
}
```

#### 5.2 Web Storage Implementation
`packages/web/src/adapters/webStorage.ts`:
```typescript
import { IStorageAdapter } from '@bermuda/shared/adapters/storage';

export class WebStorageAdapter implements IStorageAdapter {
  async getItem(key: string) {
    return localStorage.getItem(key);
  }

  async setItem(key: string, value: string) {
    localStorage.setItem(key, value);
  }

  async removeItem(key: string) {
    localStorage.removeItem(key);
  }

  async clear() {
    localStorage.clear();
  }
}
```

Initialize in `packages/web/src/index.tsx`:
```typescript
import { setStorageAdapter } from '@bermuda/shared/adapters/storage';
import { WebStorageAdapter } from './adapters/webStorage';

// Initialize platform adapters
setStorageAdapter(new WebStorageAdapter());

// Then render app
```

#### 5.3 Mobile Storage Implementation
`packages/mobile/src/adapters/mobileStorage.ts`:
```typescript
import AsyncStorage from '@react-native-async-storage/async-storage';
import { IStorageAdapter } from '@bermuda/shared/adapters/storage';

export class MobileStorageAdapter implements IStorageAdapter {
  async getItem(key: string) {
    return AsyncStorage.getItem(key);
  }

  async setItem(key: string, value: string) {
    return AsyncStorage.setItem(key, value);
  }

  async removeItem(key: string) {
    return AsyncStorage.removeItem(key);
  }

  async clear() {
    return AsyncStorage.clear();
  }
}
```

Initialize in `packages/mobile/App.tsx`:
```typescript
import { setStorageAdapter } from '@bermuda/shared/adapters/storage';
import { MobileStorageAdapter } from './src/adapters/mobileStorage';

// Initialize platform adapters
setStorageAdapter(new MobileStorageAdapter());
```

#### 5.4 Update Services to Use Adapter
In `packages/shared/src/services/launchDatabase.ts`:
```typescript
// Before:
const data = localStorage.getItem('launches');

// After:
import { getStorageAdapter } from '../adapters/storage';
const storage = getStorageAdapter();
const data = await storage.getItem('launches');
```

---

### Phase 6: Service Audit (Full Day)

Audit each service for browser dependencies:

**Services Needing Adapter Updates:**
1. ✅ `launchDatabase.ts` - Replace localStorage
2. ✅ `indexedDBCache.ts` - Replace IndexedDB
3. ✅ `notificationService.ts` - Platform-specific notifications
4. 🔧 `imageAnalysisService.ts` - May need WebView on mobile

**Services That Should Work As-Is:**
- All calculation services (visibility, trajectory, etc.)
- All utility functions
- API clients (fetch works on React Native)

Create checklist:
```markdown
- [ ] launchDatabase.ts - storage adapter
- [ ] indexedDBCache.ts - storage adapter
- [ ] notificationService.ts - notification adapter
- [ ] Test all other services on mobile
```

---

### Phase 7: Clean Mobile Dependencies (2 hours)

#### 7.1 Audit Current Dependencies
```bash
cd packages/mobile
npm list --depth=0 > current-deps.txt
```

#### 7.2 Create Clean package.json
Only keep what mobile actually needs:
```json
{
  "dependencies": {
    "@bermuda/shared": "workspace:*",
    "expo": "~54.0.0",
    "react": "18.2.0",
    "react-native": "0.76.5",
    "@react-navigation/native": "^6.0.0",
    "@react-navigation/stack": "^6.0.0",
    "@react-native-async-storage/async-storage": "^2.1.0",
    "expo-notifications": "~0.30.0",
    "expo-device": "~6.0.0",
    "react-native-gesture-handler": "~2.20.0",
    "react-native-reanimated": "~3.16.0",
    "react-native-safe-area-context": "~4.14.0",
    "react-native-screens": "~4.4.0"
  }
}
```

#### 7.3 Remove node_modules and Reinstall
```bash
rm -rf node_modules package-lock.json
npm install
```

Should go from 820 packages → ~150 packages

---

## Git Strategy

### Option 1: Fresh Monorepo (Recommended)
Start clean with proper structure:
```bash
cd /Users/pato/bermuda-rocket-tracker-monorepo
git init
git add .
git commit -m "Initial monorepo setup with Turborepo"
```

Keep old repos as backup for now.

### Option 2: Migrate Git History
More complex but preserves history:
```bash
# Use git filter-branch or git subtree
# (Advanced - not recommended unless you need history)
```

---

## Verification Checklist

After migration:
- [ ] Root: `npm install` succeeds
- [ ] Root: `npm run build` builds all packages
- [ ] Shared: Has no browser dependencies
- [ ] Web: Imports from `@bermuda/shared`
- [ ] Web: `npm start` works
- [ ] Mobile: Imports from `@bermuda/shared`
- [ ] Mobile: `npx expo start` works
- [ ] Both apps show same data (shared logic working)

---

## Timeline

| Task | Time | Cumulative |
|------|------|------------|
| Complete shared package | 30min | 30min |
| Move web app | 1hr | 1.5hr |
| Move mobile app | 1hr | 2.5hr |
| Install & test | 30min | 3hr |
| Create adapters | 2-3hr | 5-6hr |
| Audit services | 8hr | 13-14hr |
| Clean dependencies | 2hr | 15-16hr |
| **TOTAL** | **15-16hr** | **2 work days** |

---

## Current State (Where We Are)

✅ Monorepo structure created
✅ Turborepo configured
✅ packages/shared package.json created
❌ Services not yet copied
❌ Apps not yet moved
❌ Adapters not created

**Next Step:** Continue from Phase 1.2 (Copy services from web app)

---

## Need Help?

If stuck, check:
1. Turborepo docs: https://turbo.build/repo/docs
2. npm workspaces: https://docs.npmjs.com/cli/v10/using-npm/workspaces
3. tsup bundler: https://tsup.egoist.dev/

This migration sets you up for long-term success with:
- Single source of truth
- Automatic code sharing
- Type safety across apps
- Independent deployment
- Easy maintenance
